name: Docs Build

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      run_link_checks:
        description: "Run link checker on built site"
        default: true
        required: false
        type: boolean
      run_accessibility:
        description: "Run pa11y/lighthouse audits"
        default: false
        required: false
        type: boolean
      deploy_preview:
        description: "Publish preview via GitHub Pages (PRs)"
        default: false
        required: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "poetry"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: poetry install --with dev

      - name: Build docs (strict)
        run: poetry run mkdocs build --strict

      - name: Markdown style (PyMarkdown)
        run: poetry run pymarkdown -c .pymarkdown.json scan docs

      - name: Spell check (codespell)
        run: poetry run codespell docs

      - name: Link check
        if: inputs.run_link_checks
        uses: lycheeverse/lychee-action@v2
        with:
          args: --config lychee.toml site

      - name: Accessibility audit (pa11y)
        if: inputs.run_accessibility
        uses: pa11y/pa11y-ci-action@v1
        with:
          config: .pa11yci.json

      - name: Lighthouse smoke
        if: inputs.run_accessibility
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: lighthouserc.js

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site
          retention-days: 7

      - name: Configure Pages
        if: inputs.deploy_preview && github.event_name == 'pull_request'
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        if: inputs.deploy_preview && github.event_name == 'pull_request'
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy Pages preview
        if: inputs.deploy_preview && github.event_name == 'pull_request'
        id: deployment
        uses: actions/deploy-pages@v4
