name: Publish

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: "Optional release notes override (Markdown)."
        required: false
        type: string
  push:
    tags:
      - "v*.*.*"

jobs:
  publish:
    if: github.event_name != 'push' || github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Determine release metadata
        id: release_meta
        run: |
          set -euo pipefail
          version="$(python - <<'PY'
import tomllib
from pathlib import Path
pyproject = tomllib.loads(Path("pyproject.toml").read_text())
print(pyproject["tool"]["poetry"]["version"])
PY
)"
          tag="v${version}"
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            ref="${GITHUB_REF##*/}"
            if [[ "$ref" != "$tag" ]]; then
              echo "::error::Git tag $ref does not match pyproject version $tag"
              exit 1
            fi
          fi
          {
            echo "version=$version"
            echo "tag=$tag"
          } >> "$GITHUB_OUTPUT"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install poetry pip-audit
          poetry self add poetry-plugin-export

      - name: Install project dependencies
        run: poetry install

      - name: Run release quality gate
        env:
          RELEASE_VERSION: ${{ steps.release_meta.outputs.version }}
        run: |
          echo "Preparing release ${RELEASE_VERSION}"
          poetry run ruff check
          poetry run ruff format --check
          poetry run mypy
          poetry run pytest-safe --maxfail=1
          poetry export --format requirements.txt --without-hashes --output requirements.txt
          poetry run pip-audit -r requirements.txt
          poetry run mkdocs build
          poetry run release-guard

      - name: Build distributions
        run: poetry build

      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

      - name: Publish GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ steps.release_meta.outputs.tag }}
          RELEASE_NOTES_INPUT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_notes || '' }}
        run: |
          set -euo pipefail
          mkdir -p dist
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release $TAG_NAME already exists; uploading assets."
            gh release upload "$TAG_NAME" dist/* --clobber
            exit 0
          fi

          if [[ -n "$RELEASE_NOTES_INPUT" ]]; then
            printf '%s\n' "$RELEASE_NOTES_INPUT" > release-notes.md
            gh release create "$TAG_NAME" dist/* \
              --title "$TAG_NAME" \
              --notes-file release-notes.md \
              --latest
          else
            gh release create "$TAG_NAME" dist/* \
              --title "$TAG_NAME" \
              --generate-notes \
              --latest
          fi
